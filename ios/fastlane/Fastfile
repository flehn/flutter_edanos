# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
  desc "Push a new beta build to TestFlight"
  # CI: builds without codesign via flutter, then signs with match + build_app
  # Local: can run flutter build ipa first, then this lane just uploads a
  lane :beta do
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_KEY_ID"],
      issuer_id: ENV["APP_STORE_ISSUER_ID"],
      key_content: ENV["APP_STORE_KEY_P8"],
    )

    if ENV["CI"]
      # On CI: create a temporary keychain and install certs via Match
      setup_ci

      match(
        type: "appstore",
        api_key: api_key,
        readonly: true,
      )

      # Build and sign the app (Flutter already ran flutter build ios --no-codesign)
      update_code_signing_settings(
        use_automatic_signing: false,
        path: "Runner.xcodeproj",
        team_id: "Z4C8GG545Z",
        profile_name: ENV["sigh_brotherarts.EdanosAI.FoodNutritionScan.flutter_appstore_profile-name"],
        code_sign_identity: "Apple Distribution",
      )

      build_app(
        workspace: "Runner.xcworkspace",
        scheme: "Runner",
        export_method: "app-store",
        output_directory: "../build/ios/ipa",
        output_name: "Runner.ipa",
        xcargs: "-allowProvisioningUpdates",
      )
    else
      # Local: expect flutter build ipa was already run
      ipa_path = File.join(__dir__, "..", "..", "build", "ios", "ipa", "Runner.ipa")
      unless File.exist?(ipa_path)
        UI.user_error!("IPA not found at #{ipa_path}. Run 'flutter build ipa' from project root first.")
      end
    end

    ipa_path ||= File.join(__dir__, "..", "..", "build", "ios", "ipa", "Runner.ipa")

    upload_to_testflight(
      api_key: api_key,
      ipa: ipa_path,
    )
  end
end
